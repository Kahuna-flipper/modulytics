<!DOCTYPE html>
<html lang="en" style="height: 100vh;">
<head>
    <title>Modulytics: Search Genes</title>
    <!-- Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>

    <!-- Bootstrap CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <!-- Font -->
     <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <style>
        * {
            font-family: 'Roboto', 'Helvetica', 'Segoe UI', sans-serif;
        }

        #search_box {
            background-color: #A8D0E6;
            color: black;
        }

        #searchBtn {
            background-color: #5D5C61;
            color: white;
        }

        .result {
            list-style-type: none;
            border: 1px solid #BBBBBB;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            margin-right: 70px;
        }

        .no-results {
            list-style-type: none;
        }

        .header {
            background-color: #5D5C61;
            color: white;
            margin-bottom: 0rem;
            padding: 0.4rem;
            padding-left: 0.7rem;
        }

        .header a {
            color: white;
        }

        .header a:hover {
            color: #A8D0E6;
        }

        .dropdown-menu {
            background-color: #5D5C61;
        }

        .dropdown-item {
            color: white;
        }

        #left_col {
            background-color: #A8D0E6;
            padding: 1rem;
            padding-bottom: 4.5rem;
            height: 95vh;
        }

        #left_col_content {
            position: sticky;
            top: 4.5rem;
        }

        .card {
            background-color: #5D5C61;
        }

        .im_head_meta_cat {
            margin-bottom: 0rem;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .im_head_meta_val {
            color: white;
        }

        .im_head_meta_val a {
            color: #A8D0E6;
        }
    </style>
</head>
<body style="height: 100vh;">

<!-- Page Content -->
<div class="container-fluid" style="min-width: 650px; max-width: 1600px">

    <!-- Navbar -->
    <div class="header row navbar-dark sticky-top">

        <div class="navbar-header">
            <a class="navbar-brand" href="index.html">
                <img src="images/modulytics_logo.png" width="30" height="30" class="d-inline-block align-top" alt=""
                     loading="lazy">
                Modulytics
            </a>
        </div>

        <ul class="nav navbar-dark">
            <li class="nav-item">
                <a id="dataset_link" class="nav-link navbar-dark" href="dataset.html?organism=e_coli&dataset=precise1">iModulon
                    List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="about.html">About</a>
            </li>
        </ul>
    </div>

    <div class="row">
        <!-- Left column: Header -->
        <div id="left_col" class="col-md-3">
            <div id="left_col_content">

                <h1 id="title" class="bd-title"></h1>
                <div class="card p-2" id="header"></div>
            </div>
        </div>

        <!-- Main body -->
        <div class="col-md-9 p-3">
            <!-- Search -->
            <div class="row mx-auto justify-content-center">
                <div id="search_box" class="card p-3" style="width: 100%">
                    <p class="card-body text-center" style="font-size: larger">
                        Enter a gene name or locus tag below.
                    </p>
                    <div class="input-group mx-auto px-5">
                        <input type="text" class="form-control" placeholder="" id="searchText">
                        <div class="input-group-append">
                            <button class="btn btn-dark" id="searchBtn" onclick="search()">
                                Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <ul id="results"></ul>
            </div>
            <div class="tall-row"></div>
            <hr>
            <!-- Footer -->
            <footer>
                <div class="container">
                    <div class="row">
                        <div class="col-sm-3">
                            <a href="http://systemsbiology.ucsd.edu/">
                                <img class="img-fluid" src="images/sbrg-logo.png">
                            </a>
                        </div>
                        <div class="col-sm-9 m-auto">
                            <p class="copyright text-muted small">
                                Modulytics is maintained by the Systems Biology Research Group at the University of
                                California, San Diego. <br/>
                            </p>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
</div>

<!-- Required CDNs: URLSearchParams, Papa Parse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
;

<!-- Populate page -->
<script>
    // parse url
    var params = new URLSearchParams(window.location.search);
    var org_folder = 'organisms/' + params.get('organism') + '/' + params.get('dataset') + '/';
    var link_suffix = "?organism=" + params.get('organism') + "&dataset=" + params.get('dataset');

    // Update iModulon dataset page link
    document.getElementById("dataset_link").setAttribute('href', 'dataset.html' + link_suffix);

    // populate the dataset info
    $.get(org_folder + 'dataset_meta.csv', function (meta) {
        var metadata = Papa.parse(meta).data;

        // dataset title
        var title = metadata[0][1]
        document.title = 'Modulytics: ' + title.replace(/(<([^>]+)>)/ig, '');
        $('#title').append(title + ' Dataset');

        // header text
        for (i = 1; i < metadata.length - 1; i++) {
            $('#header').append('<p class="im_head_meta_cat">' + metadata[i][0].toUpperCase() + '</p>')
            $('#header').append('<p class="im_head_meta_val">' + metadata[i][1] + '</p>');
        }
    });

    // fetch json file
    let gene_list = [];
    let im_list = [];

    async function run() {
        const response = await fetch(org_folder + "gene_page_files/gene_list.json");
        gene_list = await response.json();
    }

    run();

    // Search functionality below
    const geneResultItem = ({gene_name, gene_id, product}) => {
        return `<li class="result"><a href="gene.html${link_suffix}&gene_id=${gene_id}"><b>${gene_name}</b> : ${gene_id}</a>   (<i>gene product: ${product}</i>) </li>`
    };

    const imResultItem = ({im_name, im_function}) => {
        return `<li class="result"><a href="gene.html${link_suffix}&gene_id=${gene_id}"><b>${gene_name}</b> : ${gene_id}</a>   (<i>gene product: ${product}</i>) </li>`
    };

    const geneHeader = `<li class="geneHeader"> GENES </li>`;
    const imHeader = `<li class="imHeader"> IMODS </li>`;
    const noResults = `<li class="no-results"> No results found - please try again. To see a list of all available data, empty the input field and click the "Search" button. </li>`

    async function search() {
        // clear previous results
        $('#results').empty();

        const showGenes = true; // TODO: get this from the checkbox
        const showIMs = true; // TODO: get from checkbox too

        const searchTerm = $('#searchText').val().toLowerCase();
        const geneResults = !showGenes ? [] : gene_list.filter(gene => gene.gene_name.toLowerCase().includes(searchTerm) ||
            gene.gene_id.toLowerCase().includes(searchTerm) || gene.product.toLowerCase().includes(searchTerm));

        const imResults = !showIMs ? [] : im_list.filter(im => im);

        const geneListItems = geneResults.map(result => geneResultItem(result));
        const imListItems = imResults.map(result => imResultItem(result));

        if (showGenes) {
            geneListItems.unshift(geneHeader)
            if (geneListItems.length == 1) {
                geneListItems.push(noResults)
            }
        };

        if (showIMs) {
            imListItems.unshift(imHeader)
            if (imListItems.length == 1) {
                imListItems.push(noResults)
            }
        };

        const allResultItems = imListItems.concat(geneListItems)

        allResultItems.forEach((r) => {
            $('#results').append(r);
        });

        // Show 'no results found' message when there are no elements
        if (!$('#results').children().length) {
            $('#results').append('<div class="no-results">No results found. Please enter a valid gene name or locus tag. To see a list of all available genes, empty the input field and click the "Search" button. </div>')
        }
    };

    var input = document.getElementById("searchText");
    input.addEventListener(
        "keyup", function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                document.getElementById("searchBtn").click();
            }
        }
    )
</script>
</body>
</html>